<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VAMSA - Order Your Drink</title>
  <link rel="stylesheet" href="/css/customer.css" />
</head>

<body>

  <div class="top-bar">
      <!-- Left side: logged in user -->
      <% if (user) { %>
          <span class="navbar-user">
              Logged in as <%= user.displayName %>, <%= user.role %>
          </span>
      <% } %>

      <!-- Right side: navigation buttons -->
      <div class="nav-buttons">
          <button id="translateBtn" data-lang="es"><span>üá™üá∏</span> <span>Translate to Spanish</span></button>
          <!-- Weather badge (same element ID/class pattern as manager.ejs) -->
          <a id="weatherBadge" class="nav-btn weather-btn" aria-live="polite">Loading‚Ä¶</a>

          <a href="/logout" class="nav-btn logout">Logout</a>
      </div>
  </div>

  <br>
  <!-- Top header for customer view -->
  <div class="container">
    <header class="header">
      <div class="header-content-wrapper">
        <div class="header-text">
          <h1 class="logo">üßã VAMSA</h1>
          <p class="tagline">Choose your perfect boba experience</p>
        </div>
        <div class="header-controls">
          <button
            type="button"
            class="text-size-toggle"
            id="textSizeToggle"
            aria-pressed="false"
            aria-label="Increase text size"
            title="Increase text size"
          >
            aA   
          </button>
          <!-- made button UI better -->
          <button
            type="button"
            class="contrast-toggle"
            id="contrastToggle"
            aria-pressed="false"
            aria-label="Toggle high contrast mode"
            title="Toggle high contrast mode"
          >
            üé®
          </button>
          <div class="cart-icon-container">
            <button class="cart-icon-btn" id="cartIconBtn">
              <span class="cart-icon">üõí</span>
              <span class="cart-badge" id="cartBadge" style="display:none;">0</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content">
      <!-- Weather-Based Recommendation Section -->
      <section class="recommendation-section" id="recommendationSection" style="display: none;">
        <div class="recommendation-banner">
          <h2 class="recommendation-title">
            <span id="recommendationIcon">üå°Ô∏è</span>
            <span id="recommendationText">Weather-Based Recommendation</span>
          </h2>
          <p class="recommendation-subtitle" id="recommendationSubtitle">
            Based on today's weather, we recommend:
          </p>
        </div>
        <div class="recommended-drinks-grid" id="recommendedDrinksGrid">
          <!-- Recommended drinks will be inserted here -->
        </div>
      </section>

      <!-- Popular Drinks Recommendation Section -->
      <section class="recommendation-section" id="popularDrinksSection" style="display: none;">
        <div class="recommendation-banner">
          <h2 class="recommendation-title">
            <span id="popularDrinksIcon">‚≠ê</span>
            <span id="popularDrinksText">Most Popular Drink</span>
          </h2>
          <p class="recommendation-subtitle" id="popularDrinksSubtitle">
            Based on the past month's order history, our most popular drink:
          </p>
        </div>
        <div class="recommended-drinks-grid" id="popularDrinksGrid">
          <!-- Popular drinks will be inserted here -->
        </div>
      </section>

      <section class="drinks-section">
        <h2 class="section-title">Our Signature Drinks</h2>

        <div class="search-container">
          <input
            type="text"
            id="searchInput"
            placeholder="Search drinks..."
            data-original-placeholder="Search drinks..."
          >
        </div>

        <div class="drinks-grid">
          <% menuItems.forEach(item => { %>
            <div class="drink-card"
                 data-drink="<%= item.itemname %>"
                 data-description="<%= item.itemdescription || '' %>">
              <div class="drink-image classic"></div>
              <h3 class="drink-name"><%= item.itemname %></h3>
              <p class="drink-description"><%= item.itemdescription %></p>
              <div
                class="price"
                data-price="<%= typeof item.itemprice === 'number'
                  ? item.itemprice
                  : parseFloat(String(item.itemprice).replace(',', '.')) || 0 %>">
                $<%= (
                  typeof item.itemprice === 'number'
                    ? item.itemprice
                    : parseFloat(String(item.itemprice).replace(',', '.')) || 0
                ).toFixed(2) %>
              </div>
            </div>
          <% }) %>
        </div>
      </section>
    </main>

    <footer class="footer"></footer>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="modal">
    <div class="modal-content cart-modal-content">
      <div class="modal-header cart-header">
        <div class="cart-title-wrap">
          <h2>Your Cart</h2>
          <span class="cart-count-badge" id="cartCountBadge">0</span>
        </div>
        <span class="close cart-close">&times;</span>
      </div>

      <div class="modal-body cart-modal-body">
        <div id="cartItems" class="cart-items">
          <p class="empty-cart-message">Your cart is empty</p>
        </div>

        <div class="cart-summary">
          <div class="summary-row">
            <span>Subtotal</span><span id="cartSubtotal">$0.00</span>
          </div>
          <div class="summary-row">
            <span>Tax <small id="taxRateLabel"></small></span><span id="cartTax">$0.00</span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total-row">
            <span>Total</span><span id="cartTotal">$0.00</span>
          </div>
        </div>
      </div>

      <div class="modal-footer cart-footer">
        <button class="btn-add-more-drinks" id="addMoreDrinksBtn">Add More Drinks</button>
        <button class="btn-clear-cart" id="clearCartBtn">Clear Cart</button>
        <button class="btn-checkout" id="checkoutBtn" disabled>Checkout</button>
      </div>
    </div>
  </div>

  <!-- Customization Modal -->
  <div id="customizationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalDrinkName">Customize Your Drink</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="customizations-column">
          <div class="customization-section">
            <h3>Size</h3>
            <div class="option-group">
              <label class="option-btn">
                <input type="radio" name="orderSize" value="Small" checked>
                <span>Small</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="orderSize" value="Medium">
                <span>Medium</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="orderSize" value="Large">
                <span>Large</span>
              </label>
            </div>
          </div>

          <div class="customization-section">
            <h3>Temperature</h3>
            <div class="option-group">
              <label class="option-btn">
                <input type="radio" name="temperature" value="Hot" checked>
                <span>Hot</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="temperature" value="Cold">
                <span>Cold</span>
              </label>
            </div>
          </div>

          <div class="customization-section">
            <h3>Ice Level</h3>
            <div class="option-group">
              <label class="option-btn">
                <input type="radio" name="iceLevel" value="no ice">
                <span>No Ice</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="iceLevel" value="light ice" checked>
                <span>Light Ice</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="iceLevel" value="regular">
                <span>Regular</span>
              </label>
            </div>
          </div>

          <div class="customization-section">
            <h3>Sugar Level</h3>
            <div class="option-group">
              <label class="option-btn">
                <input type="radio" name="sugarLevel" value="No Sugar">
                <span>No Sugar</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="sugarLevel" value="25%">
                <span>25%</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="sugarLevel" value="50%" checked>
                <span>50%</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="sugarLevel" value="75%">
                <span>75%</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="sugarLevel" value="100%">
                <span>100%</span>
              </label>
              <label class="option-btn">
                <input type="radio" name="sugarLevel" value="120%">
                <span>120% (Extra Sugar)</span>
              </label>
            </div>
          </div>

          <div class="customization-section">
            <h3>Toppings</h3>
            <div class="toppings-grid">
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Boba Pearls"><span>Boba Pearls</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Pudding"><span>Pudding</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Grass Jelly"><span>Grass Jelly</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Aloe Vera"><span>Aloe Vera</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Lychee Jelly"><span>Lychee Jelly</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Mango Popping"><span>Mango Popping</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Strawberry Popping"><span>Strawberry Popping</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Coffee Jelly"><span>Coffee Jelly</span>
              </label>
              <label class="topping-checkbox">
                <input type="checkbox" name="toppings" value="Crystal Boba"><span>Crystal Boba</span>
              </label>
            </div>
          </div>
        </div>

        <div class="order-summary">
          <h3>Order Summary</h3>
          <div class="summary-content">
            <div class="summary-item">
              <span class="summary-label">Drink:</span>
              <span id="summaryDrinkName" class="summary-value">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Size:</span>
              <span id="summarySize" class="summary-value">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Temperature:</span>
              <span id="summaryTemperature" class="summary-value">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ice Level:</span>
              <span id="summaryIceLevel" class="summary-value">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Sugar Level:</span>
              <span id="summarySugarLevel" class="summary-value">-</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Toppings:</span>
              <span id="summaryToppings" class="summary-value">None</span>
            </div>
            <div class="summary-item toppings-list" id="toppingsList" style="display:none;">
              <ul id="toppingsListItems"></ul>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-item price-breakdown">
              <div class="price-line">
                <span class="summary-label">Base Price:</span>
                <span id="summaryBasePrice" class="summary-value">$0.00</span>
              </div>
              <div class="price-line" id="toppingsPriceLine" style="display:none;">
                <span class="summary-label">
                  Toppings (<span id="toppingCount">0</span> √ó $1.00):
                </span>
                <span id="summaryToppingsPrice" class="summary-value">$0.00</span>
              </div>
            </div>
            <div class="summary-item total-price">
              <span class="summary-label">Total:</span>
              <span id="summaryTotalPrice" class="summary-value total">$0.00</span>
            </div>
          </div>
          <div class="summary-buttons">
            <button class="btn-cancel">Cancel</button>
            <button class="btn-add-to-cart">Add to Cart</button>
          </div>
        </div>
      </div>
      <div class="modal-footer"></div>
    </div>
  </div>

  <!-- Status / Notice Modal -->
  <div id="statusModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="statusTitle">Notice</h2>
        <span class="close status-close">&times;</span>
      </div>
      <div class="modal-body">
        <p id="statusMessage"></p>
        <div id="statusDetails"></div>
      </div>
      <div class="modal-footer">
        <button id="statusOkBtn" class="btn-checkout">OK</button>
      </div>
    </div>
  </div>

  <script>
    // --- Status modal helpers ---
    const statusModal   = document.getElementById('statusModal');
    const statusTitle   = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    const statusDetails = document.getElementById('statusDetails');
    const statusOkBtn   = document.getElementById('statusOkBtn');
    const statusClose   = document.querySelector('.status-close');

    function showStatus({ title = 'Notice', message = '', detailsHtml = '' }) {
      statusTitle.textContent = title;
      statusMessage.textContent = message;
      statusDetails.innerHTML = detailsHtml;
      statusModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function hideStatus() {
      statusModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      statusDetails.innerHTML = '';
    }

    statusOkBtn?.addEventListener('click', hideStatus);
    statusClose?.addEventListener('click', hideStatus);
    window.addEventListener('click', (e) => {
      if (e.target === statusModal) hideStatus();
    });
  </script>

  <script>
    // --- config / money ---
    const TAX_RATE = 0.0825;
    const money = n => `$${n.toFixed(2)}`;

    // --- DOM refs (cart) ---
    const cartModal = document.getElementById('cartModal');
    const cartIconBtn = document.getElementById('cartIconBtn');
    const cartBadge = document.getElementById('cartBadge');
    const cartItems = document.getElementById('cartItems');
    const cartCloseBtn = document.querySelector('.cart-close');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const addMoreDrinksBtn = document.getElementById('addMoreDrinksBtn');
    const cartSubtotalEl = document.getElementById('cartSubtotal');
    const cartTaxEl = document.getElementById('cartTax');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartCountBadge = document.getElementById('cartCountBadge');
    const taxRateLabel = document.getElementById('taxRateLabel');
    taxRateLabel.textContent = `(${(TAX_RATE*100).toFixed(2)}%)`;

    // --- text-size toggle ---
    const textSizeToggle = document.getElementById('textSizeToggle');

    let textLarge = false;
    try { textLarge = localStorage.getItem('vamsa_text_large') === 'true'; } catch {}
    function applyTextSizeState(isLarge) {
      document.documentElement.classList.toggle('big-text', isLarge);
      textSizeToggle.classList.toggle('is-active', isLarge);
      textSizeToggle.setAttribute('aria-pressed', String(isLarge));
      textSizeToggle.title = isLarge ? "Reduce text size" : "Increase text size";
    }
    applyTextSizeState(textLarge);
    textSizeToggle.addEventListener('click', () => {
      textLarge = !textLarge;
      applyTextSizeState(textLarge);
      try { localStorage.setItem('vamsa_text_large', String(textLarge)); } catch {}
    });

    // --- contrast toggle ---
    const contrastToggle = document.getElementById('contrastToggle');
    let highContrast = false;

    function applyContrastState(isHighContrast) {
      document.body.classList.toggle('high-contrast-mode', isHighContrast);
      contrastToggle.classList.toggle('is-active', isHighContrast);
      contrastToggle.setAttribute('aria-pressed', String(isHighContrast));
      contrastToggle.textContent = 'üé®';
      contrastToggle.title = isHighContrast ? "Disable high contrast mode" : "Enable high contrast mode";
    }

    applyContrastState(false);
    contrastToggle.addEventListener('click', () => {
      highContrast = !highContrast;
      applyContrastState(highContrast);
      try { localStorage.setItem('vamsa_high_contrast', String(highContrast)); } catch {}
    });

    let basePrice = 0;
    let cart = [];

    // open/close cart
    const openCart = async () => {
      cartModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      await updateCartDisplay();
    };
    const closeCart = () => {
      cartModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    };
    cartIconBtn.addEventListener('click', openCart);
    cartCloseBtn.addEventListener('click', closeCart);
    window.addEventListener('click', (e) => { if (e.target === cartModal) closeCart(); });

    addMoreDrinksBtn.addEventListener('click', () => {
      closeCart();
    });

    clearCartBtn.addEventListener('click', async () => {
      if (cart.length && confirm('Clear cart?')) {
        cart = [];
        updateCartBadge();
        await updateCartDisplay();
      }
    });

    // checkout -> POST /customer/checkout
    checkoutBtn.addEventListener('click', async () => {
      if (!cart.length) {
        return showStatus({
          title: 'Cart empty',
          message: 'Your cart is empty!'
        });
      }

      try {
        const payload = {
          cart: cart.map(({ drink, toppings, qty, size, temperature, iceLevel, sugarLevel }) => ({
            drink,
            toppings,
            quantity: qty || 1,
            size,
            temperature,
            iceLevel,
            sugarLevel
          }))
        };

        const res = await fetch('/customer/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // ----- failure path -----
        if (!res.ok) {
          const text = await res.text();
          try {
            const err = JSON.parse(text);
            const detailsHtml =
              Array.isArray(err.shortages) && err.shortages.length
                ? '<ul>' +
                  err.shortages
                    .map(
                      (s) =>
                        `<li>${s.ingredient}: need ${s.need}, have ${s.have}</li>`
                    )
                    .join('') +
                  '</ul>'
                : '';
            showStatus({
              title: 'Checkout failed',
              message: err.message || 'Request failed.',
              detailsHtml
            });
          } catch {
            showStatus({
              title: 'Checkout failed',
              message: `HTTP ${res.status} ${text}`
            });
          }
          return;
        }

        // ----- success path -----
        const data = await res.json();

        // Build final order summary HTML BEFORE clearing the cart
        const orderSummaryHtml = `
          <div class="status-order-layout">
            <div class="status-order-id">
              <p>Your order ID is <strong>${data.orderId}</strong>.</p>
            </div>
            <div class="status-order-summary">
              <h3>Order Summary</h3>
              <ul class="status-order-items">
                ${cart
                  .map((item) => {
                    const qty = item.qty || 1;
                    const toppingsText =
                      item.toppings && item.toppings.length
                        ? item.toppings.join(', ')
                        : 'No toppings';
                    return `
                      <li class="status-order-item">
                        <div class="status-item-name">
                          <strong>${qty}√ó ${item.drink}</strong>
                        </div>
                        <div class="status-item-meta">
                          Size: ${item.size || 'Small'} ‚Ä¢
                          Temp: ${item.temperature || 'Hot'} ‚Ä¢
                          Ice: ${item.iceLevel} ‚Ä¢
                          Sugar: ${item.sugarLevel} ‚Ä¢
                          Toppings: ${toppingsText}
                        </div>
                      </li>
                    `;
                  })
                  .join('')}
              </ul>
              <div class="status-order-totals">
                <p>Subtotal: <strong>${cartSubtotalEl.textContent}</strong></p>
                <p>Tax: <strong>${cartTaxEl.textContent}</strong></p>
                <p class="status-order-total-row">
                  Total: <strong>${cartTotalEl.textContent}</strong>
                </p>
              </div>
            </div>
          </div>
        `;

        showStatus({
          title: 'Order placed!',
          message: '',
          detailsHtml: orderSummaryHtml
        });

        // Clear cart after showing summary
        cart = [];
        updateCartBadge();
        updateCartDisplay();
      } catch (err) {
        console.error(err);
        showStatus({
          title: 'Checkout failed',
          message: 'Unexpected error. Please try again.'
        });
      }
    });

    // cart helpers
    function updateCartBadge() {
      const count = cart.reduce((n, it) => n + (it.qty || 1), 0);
      cartBadge.textContent = count;
      cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
    async function removeFromCart(i){
      cart.splice(i,1);
      updateCartBadge();
      await updateCartDisplay();
    }

    async function updateCartDisplay() {
      if (!cart.length) {
        cartItems.innerHTML = '<p class="empty-cart-message">Your cart is empty</p>';
        cartSubtotalEl.textContent = money(0);
        cartTaxEl.textContent = money(0);
        cartTotalEl.textContent = money(0);
        cartCountBadge.textContent = '0';
        checkoutBtn.disabled = true;
        return;
      }

      const isSpanish = window.shouldTranslateToSpanish && window.shouldTranslateToSpanish();
      let html = '', subtotal = 0;

      for (let i = 0; i < cart.length; i++) {
        const item = cart[i];
        const qty = item.qty || 1;
        const line = item.totalPrice * qty;
        subtotal += line;

        let displayDrinkName = item.drink;
        let displaySize = item.size || 'Small';
        let displayTemperature = item.temperature || 'Hot';
        let displayIceLevel = item.iceLevel;
        let displaySugarLevel = item.sugarLevel;
        let displayToppings = item.toppings.join(', ');

        if (isSpanish) {
          // Drink name
          try {
            const drinkRes = await fetch("/translate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                target: "es",
                texts: [item.drink]
              })
            });
            if (drinkRes.ok) {
              const drinkData = await drinkRes.json();
              if (drinkData.translations && drinkData.translations.length > 0) {
                displayDrinkName = drinkData.translations[0];
              }
            }
          } catch (e) {
            console.warn("Failed to translate drink name:", e);
          }

          // Ice level
          const iceLevelText = item.iceLevel.split(' ').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
          ).join(' ');
          try {
            const iceRes = await fetch("/translate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                target: "es",
                texts: [iceLevelText]
              })
            });
            if (iceRes.ok) {
              const iceData = await iceRes.json();
              if (iceData.translations && iceData.translations.length > 0) {
                displayIceLevel = iceData.translations[0];
              }
            }
          } catch (e) {
            console.warn("Failed to translate ice level:", e);
          }

          // Toppings
          if (item.toppings.length > 0) {
            try {
              const toppingsRes = await fetch("/translate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  target: "es",
                  texts: item.toppings
                })
              });
              if (toppingsRes.ok) {
                const toppingsData = await toppingsRes.json();
                if (toppingsData.translations &&
                    toppingsData.translations.length === item.toppings.length) {
                  displayToppings = toppingsData.translations.join(', ');
                }
              }
            } catch (e) {
              console.warn("Failed to translate toppings:", e);
            }
          }
        }

        html += `
          <div class="cart-item">
            <div class="cart-item-info">
              <h3 class="cart-item-name">${displayDrinkName}</h3>
              <div class="cart-item-details">
                <span>Size: ${displaySize}</span>
                <span>‚Ä¢ Temp: ${displayTemperature}</span>
                <span>‚Ä¢ Ice: ${displayIceLevel}</span>
                <span>‚Ä¢ Sugar: ${displaySugarLevel}</span>
                ${item.toppings.length
                  ? `<span>‚Ä¢ Toppings: ${displayToppings}</span>`
                  : ''}
              </div>
            </div>
            <div class="cart-item-price cart-item-right">
              <span class="cart-item-price-value">${money(line)}</span>
              <div class="qty-wrap">
                <button class="qty-btn" data-action="dec" data-index="${i}">‚àí</button>
                <span class="qty-value" id="qty-${i}">${qty}</span>
                <button class="qty-btn" data-action="inc" data-index="${i}">+</button>
              </div>
              <button class="btn-remove-item" data-index="${i}">Remove</button>
            </div>
          </div>`;
      }
      cartItems.innerHTML = html;

      const tax = subtotal * TAX_RATE;
      const total = subtotal + tax;
      cartSubtotalEl.textContent = money(subtotal);
      cartTaxEl.textContent = money(tax);
      cartTotalEl.textContent = money(total);
      cartCountBadge.textContent = String(cart.length);
      checkoutBtn.disabled = false;

      document.querySelectorAll('.btn-remove-item').forEach(b => {
        b.addEventListener('click', () => removeFromCart(Number(b.dataset.index)));
      });
      document.querySelectorAll('.qty-btn').forEach(b => {
        b.addEventListener('click', async () => {
          const i = Number(b.dataset.index);
          const action = b.dataset.action;
          const curr = cart[i].qty || 1;
          cart[i].qty = action === 'inc' ? curr + 1 : Math.max(1, curr - 1);
          updateCartBadge();
          await updateCartDisplay();
        });
      });
    }

    // drink card -> open customizer
    const customizationModal = document.getElementById('customizationModal');
    const modalDrinkNameEl = document.getElementById('modalDrinkName');
    let currentOriginalDrinkName = '';

    document.querySelectorAll('.drink-card').forEach(card => {
      card.addEventListener('click', async () => {
        const drink = card.getAttribute('data-drink');
        currentOriginalDrinkName = drink;
        const priceElement = card.querySelector('.price');
        const priceValue =
          priceElement.getAttribute('data-price') ||
          priceElement.textContent.replace('$','').replace(',','.');
        basePrice = parseFloat(priceValue) || 0;

        modalDrinkNameEl.dataset.originalText = drink;
        modalDrinkNameEl.textContent = drink;

        const defaultSize = document.querySelector('input[name="orderSize"][value="Small"]');
        const defaultTemperature = document.querySelector('input[name="temperature"][value="Hot"]');
        const defaultIceLevel = document.querySelector('input[name="iceLevel"][value="light ice"]');
        const defaultSugarLevel = document.querySelector('input[name="sugarLevel"][value="50%"]');
        if (defaultSize && !defaultSize.checked) defaultSize.checked = true;
        if (defaultTemperature && !defaultTemperature.checked) defaultTemperature.checked = true;
        if (defaultIceLevel && !defaultIceLevel.checked) defaultIceLevel.checked = true;
        if (defaultSugarLevel && !defaultSugarLevel.checked) defaultSugarLevel.checked = true;

        customizationModal.style.display = 'block';
        document.body.style.overflow = 'hidden';

        await updateSummary();

        if (window.shouldTranslateToSpanish &&
            window.shouldTranslateToSpanish() &&
            window.translateNewContent) {
          setTimeout(() => {
            const modalHeader = customizationModal.querySelector('.modal-header');
            const customizationsColumn = customizationModal.querySelector('.customizations-column');
            if (modalHeader) window.translateNewContent(modalHeader);
            if (customizationsColumn) window.translateNewContent(customizationsColumn);
          }, 100);
        }
      });
    });

    // ----- customization modal -----
    const closeBtn = customizationModal.querySelector('.close');
    const cancelBtn = document.querySelector('.btn-cancel');
    const addToCartBtn = document.querySelector('.btn-add-to-cart');

    const summaryDrinkName = document.getElementById('summaryDrinkName');
    const summarySize      = document.getElementById('summarySize');
    const summaryTemperature = document.getElementById('summaryTemperature');
    const summaryIceLevel  = document.getElementById('summaryIceLevel');
    const summarySugarLevel= document.getElementById('summarySugarLevel');
    const summaryToppings  = document.getElementById('summaryToppings');
    const toppingsList     = document.getElementById('toppingsList');
    const toppingsListItems= document.getElementById('toppingsListItems');
    const summaryBasePrice = document.getElementById('summaryBasePrice');
    const toppingsPriceLine= document.getElementById('toppingsPriceLine');
    const toppingCount     = document.getElementById('toppingCount');
    const summaryToppingsPrice = document.getElementById('summaryToppingsPrice');
    const summaryTotalPrice    = document.getElementById('summaryTotalPrice');

    async function translateTextIfNeeded(text, element) {
      if (!window.shouldTranslateToSpanish || !window.shouldTranslateToSpanish()) {
        return text;
      }
      if (element && !element.dataset.originalText) {
        element.dataset.originalText = text;
      }
      try {
        const res = await fetch("/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            target: "es",
            texts: [text]
          })
        });
        if (res.ok) {
          const data = await res.json();
          if (data.translations && data.translations.length > 0) {
            return data.translations[0];
          }
        }
      } catch (e) {
        console.warn("Translation failed for:", text, e);
      }
      return text;
    }

    async function updateSummary(){
      const drinkName = currentOriginalDrinkName ||
                        modalDrinkNameEl.dataset.originalText ||
                        modalDrinkNameEl.textContent;
      const sizeInput = document.querySelector('input[name="orderSize"]:checked');
      const temperatureInput = document.querySelector('input[name="temperature"]:checked');
      const iceLevelInput = document.querySelector('input[name="iceLevel"]:checked');
      const sugarLevelInput = document.querySelector('input[name="sugarLevel"]:checked');

      let size = sizeInput?.value || 'Small';
      let temperature = temperatureInput?.value || 'Hot';
      let iceLevel = iceLevelInput?.value || 'light ice';
      let sugarLevel = sugarLevelInput?.value || '50%';
      const selectedToppings =
        Array.from(document.querySelectorAll('input[name="toppings"]:checked'))
          .map(cb => cb.value);

      const iceLevelText = iceLevel.split(' ').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join(' ');

      const toppingsText = selectedToppings.length ? `${selectedToppings.length} selected` : 'None';

      summaryDrinkName.dataset.originalText = drinkName;
      summarySize.textContent = size;
      summaryTemperature.textContent = temperature;
      summaryIceLevel.dataset.originalText = iceLevelText;
      summaryToppings.dataset.originalText = toppingsText;

      const isSpanish = window.shouldTranslateToSpanish && window.shouldTranslateToSpanish();

      if (isSpanish) {
        const translatedDrinkName = await translateTextIfNeeded(drinkName, summaryDrinkName);
        const translatedIceLevel = await translateTextIfNeeded(iceLevelText, summaryIceLevel);
        const translatedToppings = await translateTextIfNeeded(toppingsText, summaryToppings);

        summaryDrinkName.textContent = translatedDrinkName;
        summaryIceLevel.textContent = translatedIceLevel;
        summaryToppings.textContent = translatedToppings;
      } else {
        summaryDrinkName.textContent = drinkName;
        summaryIceLevel.textContent = iceLevelText;
        summaryToppings.textContent = toppingsText;
      }

      summarySugarLevel.textContent = sugarLevel;

      if (selectedToppings.length){
        toppingsList.style.display = 'block';
        if (isSpanish && toppingsListItems) {
          try {
            const res = await fetch("/translate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                target: "es",
                texts: selectedToppings
              })
            });
            if (res.ok) {
              const data = await res.json();
              if (data.translations &&
                  data.translations.length === selectedToppings.length) {
                toppingsListItems.innerHTML =
                  data.translations.map(t => `<li>${t}</li>`).join('');
              } else {
                toppingsListItems.innerHTML =
                  selectedToppings.map(t => `<li>${t}</li>`).join('');
              }
            } else {
              toppingsListItems.innerHTML =
                selectedToppings.map(t => `<li>${t}</li>`).join('');
            }
          } catch (e) {
            console.warn("Failed to translate toppings:", e);
            toppingsListItems.innerHTML =
              selectedToppings.map(t => `<li>${t}</li>`).join('');
          }
        } else {
          toppingsListItems.innerHTML =
            selectedToppings.map(t => `<li>${t}</li>`).join('');
        }
      } else {
        toppingsList.style.display = 'none';
      }

      const toppingsPrice = selectedToppings.length * 1.00;
      const totalPrice    = basePrice + toppingsPrice;
      summaryBasePrice.textContent = money(basePrice);

      if (selectedToppings.length){
        toppingsPriceLine.style.display = 'block';
        toppingCount.textContent = selectedToppings.length;
        summaryToppingsPrice.textContent = money(toppingsPrice);
      } else {
        toppingsPriceLine.style.display = 'none';
      }
      summaryTotalPrice.textContent = money(totalPrice);
    }

    document.querySelectorAll('input[name="orderSize"]').forEach(r =>
      r.addEventListener('change', updateSummary)
    );
    document.querySelectorAll('input[name="temperature"]').forEach(r =>
      r.addEventListener('change', updateSummary)
    );
    document.querySelectorAll('input[name="iceLevel"]').forEach(r =>
      r.addEventListener('change', updateSummary)
    );
    document.querySelectorAll('input[name="sugarLevel"]').forEach(r =>
      r.addEventListener('change', updateSummary)
    );
    document.querySelectorAll('input[name="toppings"]').forEach(c =>
      c.addEventListener('change', updateSummary)
    );

    const resetModal = () => {
      document.querySelector('input[name="orderSize"][value="Small"]').checked = true;
      document.querySelector('input[name="temperature"][value="Hot"]').checked = true;
      document.querySelector('input[name="iceLevel"][value="light ice"]').checked = true;
      document.querySelector('input[name="sugarLevel"][value="50%"]').checked = true;
      document.querySelectorAll('input[name="toppings"]').forEach(cb => cb.checked = false);
    };

    closeBtn.addEventListener('click', () => {
      customizationModal.style.display='none';
      document.body.style.overflow='auto';
      resetModal();
    });
    cancelBtn.addEventListener('click', () => {
      customizationModal.style.display='none';
      document.body.style.overflow='auto';
      resetModal();
    });

    window.addEventListener('click', (e) => {
      if (e.target === customizationModal) {
        customizationModal.style.display='none';
        document.body.style.overflow='auto';
        resetModal();
      }
    });

    addToCartBtn.addEventListener('click', async () => {
      const drinkName = currentOriginalDrinkName ||
                        modalDrinkNameEl.dataset.originalText ||
                        modalDrinkNameEl.textContent;
      const size = document.querySelector('input[name="orderSize"]:checked').value;
      const temperature = document.querySelector('input[name="temperature"]:checked').value;
      const iceLevel  = document.querySelector('input[name="iceLevel"]:checked').value;
      const sugarLevel= document.querySelector('input[name="sugarLevel"]:checked').value;
      const selectedToppings =
        Array.from(document.querySelectorAll('input[name="toppings"]:checked'))
          .map(cb => cb.value);
      const toppingsPrice = selectedToppings.length * 1.00;
      const totalPrice = basePrice + toppingsPrice;

      cart.push({
        drink: drinkName,
        size, temperature, iceLevel, sugarLevel,
        toppings: selectedToppings,
        basePrice, toppingsPrice, totalPrice,
        qty: 1
      });
      updateCartBadge();
      customizationModal.style.display='none';
      document.body.style.overflow='auto';
      resetModal();
      cartModal.style.display = 'block';
      await updateCartDisplay();
    });
  </script>

  <!-- Weather (same code path as manager: fetch from server proxy) -->
  <script>
    (function () {
      const badge = document.getElementById('weatherBadge');
      if (!badge) return;

      const url = `/api/weather`;

      const weatherDescriptions = {
        0: "Clear sky",
        1: "Mainly clear",
        2: "Partly cloudy",
        3: "Overcast",
        45: "Fog",
        48: "Depositing rime fog",
        51: "Light drizzle",
        53: "Moderate drizzle",
        55: "Dense drizzle",
        61: "Slight rain",
        63: "Moderate rain",
        65: "Heavy rain",
        80: "Light rain showers",
        81: "Rain showers",
        82: "Violent rain showers",
        95: "Thunderstorm",
        96: "Thunderstorm w/ hail",
        99: "Thunderstorm w/ heavy hail"
      };

      function categorizeDrink(drinkName, description) {
        const name = (drinkName || '').toLowerCase();
        const desc = (description || '').toLowerCase();
        const combined = `${name} ${desc}`;

        const milkyKeywords = [
          'milk','cream','latte','cappuccino','mocha','vanilla','caramel',
          'chocolate','matcha latte','taro','coconut milk','almond milk',
          'oat milk','smoothie','milkshake','frappe','white','creamy'
        ];
        const fruityKeywords = [
          'fruit','fruity','mango','strawberry','pineapple','watermelon',
          'peach','lychee','passion','citrus','lemon','lime','orange',
          'berry','blueberry','raspberry','kiwi','grape','apple','cherry',
          'pomegranate','dragon fruit','guava','papaya','coconut water'
        ];

        const isMilky = milkyKeywords.some(k => combined.includes(k));
        const isFruity = fruityKeywords.some(k => combined.includes(k));
        if (isMilky && !isFruity) return 'milky';
        if (isFruity && !isMilky) return 'fruity';
        return isFruity ? 'fruity' : 'milky';
      }

      function getAllDrinks() {
        const drinkCards = document.querySelectorAll('.drink-card:not(.recommended-drink-card)');
        return Array.from(drinkCards).map(card => ({
          name: card.getAttribute('data-drink'),
          description: card.getAttribute('data-description') || '',
          element: card
        }));
      }

      function displayRecommendations(tempF, drinks, category) {
        const section = document.getElementById('recommendationSection');
        const grid = document.getElementById('recommendedDrinksGrid');
        const titleText = document.getElementById('recommendationText');
        const subtitle = document.getElementById('recommendationSubtitle');
        const icon = document.getElementById('recommendationIcon');

        if (!section || !grid || !titleText || !subtitle || !icon) return;

        const recommendedDrinks = drinks.filter(d =>
          categorizeDrink(d.name, d.description) === category
        );

        if (recommendedDrinks.length === 0) {
          section.style.display = 'none';
          return;
        }

        let titleEnglish, subtitleEnglish;
        if (category === 'milky') {
          icon.textContent = 'ü•õ';
          titleEnglish = 'Perfect for Cooler Weather';
          subtitleEnglish = `It's ${tempF}¬∞F outside - warm up with our creamy, milky drinks!`;
        } else {
          icon.textContent = 'üçπ';
          titleEnglish = 'Perfect for Warmer Weather';
          subtitleEnglish = `It's ${tempF}¬∞F outside - cool down with our refreshing, fruity drinks!`;
        }

        titleText.dataset.originalText = titleEnglish;
        subtitle.dataset.originalText = subtitleEnglish;

        const lang =
          window.pageLang ||
          (window.shouldTranslateToSpanish && window.shouldTranslateToSpanish() ? 'es' : 'en') ||
          sessionStorage.getItem('vamsa_page_language') ||
          'en';

        if (lang === 'en') {
          titleText.textContent = titleEnglish;
          subtitle.textContent = subtitleEnglish;
        } else {
          titleText.textContent = titleEnglish;
          subtitle.textContent = subtitleEnglish;

          const translateLater = () => {
            if (window.translateNewContent) {
              window.translateNewContent(section);
            } else {
              setTimeout(translateLater, 50);
            }
          };
          setTimeout(translateLater, 0);
          setTimeout(() => {
            if (window.translateNewContent) window.translateNewContent(section);
          }, 1000);
        }

        const displayDrinks = recommendedDrinks.slice(0, 4);
        grid.innerHTML = '';
        displayDrinks.forEach(drink => {
          const card = drink.element.cloneNode(true);
          card.classList.add('recommended-drink-card');
          card.style.cursor = 'pointer';
          card.addEventListener('click', e => {
            e.stopPropagation();
            const drinkName = card.getAttribute('data-drink');
            const originalCard = document.querySelector(
              `.drink-card[data-drink="${drinkName}"]:not(.recommended-drink-card)`
            );
            if (originalCard) originalCard.click();
          });
          grid.appendChild(card);
        });

        section.style.display = 'block';

        if (lang === 'es' && window.translateNewContent) {
          setTimeout(() => {
            window.translateNewContent(section);
          }, 100);
        }
      }

      async function loadWeather() {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const cw = data.current_weather;
          if (!cw) throw new Error("No weather data");

          const tempF = Math.round((cw.temperature * 9) / 5 + 32);
          const desc = weatherDescriptions[cw.weathercode] || "Weather";

          badge.textContent = `College Station: ${tempF}¬∞F, ${desc}`;
          badge.dataset.originalText = badge.textContent;

          const translateWeather = () => {
            if (window.translateNewContent &&
               (window.pageLang === 'es' ||
                (window.shouldTranslateToSpanish && window.shouldTranslateToSpanish()))) {
              window.translateNewContent(badge);
            }
          };

          translateWeather();
          setTimeout(translateWeather, 300);
          setTimeout(translateWeather, 1000);
          setTimeout(translateWeather, 2000);

          const TEMP_THRESHOLD = 70;
          const recommendationCategory = tempF < TEMP_THRESHOLD ? 'milky' : 'fruity';
          const allDrinks = getAllDrinks();
          displayRecommendations(tempF, allDrinks, recommendationCategory);

        } catch (e) {
          console.error("Weather client error:", e);
          badge.textContent = "Weather unavailable";
          badge.dataset.originalText = badge.textContent;

          const translateWeather = () => {
            if (window.translateNewContent &&
               (window.pageLang === 'es' ||
                (window.shouldTranslateToSpanish && window.shouldTranslateToSpanish()))) {
              window.translateNewContent(badge);
            }
          };

          translateWeather();
          setTimeout(translateWeather, 300);
          setTimeout(translateWeather, 1000);
          setTimeout(translateWeather, 2000);
        }
      }

      loadWeather();
    })();
  </script>

  <!-- Popular Drinks Recommendation -->
  <script>
    (function () {
      const section = document.getElementById('popularDrinksSection');
      const grid = document.getElementById('popularDrinksGrid');
      if (!section || !grid) return;

      function getAllDrinks() {
        const drinkCards =
          document.querySelectorAll('.drink-card:not(.recommended-drink-card):not(.popular-drink-card)');
        return Array.from(drinkCards).map(card => ({
          name: card.getAttribute('data-drink'),
          description: card.getAttribute('data-description') || '',
          element: card
        }));
      }

      function displayPopularDrinks(popularDrinkNames) {
        if (!popularDrinkNames || popularDrinkNames.length === 0) {
          section.style.display = 'none';
          return;
        }

        setTimeout(() => {
          const allDrinks = getAllDrinks();
          const popularDrinks = allDrinks.filter(d =>
            popularDrinkNames.includes(d.name)
          );

          if (popularDrinks.length === 0) {
            section.style.display = 'none';
            return;
          }

          const sorted = popularDrinkNames
            .map(name => popularDrinks.find(d => d.name === name))
            .filter(Boolean);

          const displayDrink = sorted[0];
          if (!displayDrink) {
            section.style.display = 'none';
            return;
          }

          grid.innerHTML = '';
          const card = displayDrink.element.cloneNode(true);
          card.classList.add('popular-drink-card');
          card.style.cursor = 'pointer';
          card.addEventListener('click', (e) => {
            e.stopPropagation();
            const drinkName = card.getAttribute('data-drink');
            const originalCard = document.querySelector(
              `.drink-card[data-drink="${drinkName}"]:not(.recommended-drink-card):not(.popular-drink-card)`
            );
            if (originalCard) originalCard.click();
          });
          grid.appendChild(card);

          section.style.display = 'block';

          const lang =
            window.pageLang ||
            (window.shouldTranslateToSpanish && window.shouldTranslateToSpanish() ? 'es' : 'en') ||
            sessionStorage.getItem('vamsa_page_language') ||
            'en';
          if (lang === 'es' && window.translateNewContent) {
            setTimeout(() => { window.translateNewContent(section); }, 150);
            setTimeout(() => {
              if (window.translateNewContent) window.translateNewContent(section);
            }, 1000);
          }
        }, 100);
      }

      async function loadPopularDrinks() {
        try {
          const res = await fetch('/api/popular-drinks?limit=1');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const popularDrinkNames = data.drinks.map(d => d.name);
          displayPopularDrinks(popularDrinkNames);
        } catch (e) {
          console.error("Popular drinks client error:", e);
          section.style.display = 'none';
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadPopularDrinks);
      } else {
        loadPopularDrinks();
      }
    })();
  </script>

  <script src="/js/translator.js"></script>
  <script src="/js/customer.js"></script>
</body>
</html>
